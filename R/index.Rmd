---
title: "Causal inference with competing events"
output: 
  html_document:
    date: "`r Sys.Date()`"
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    theme: flatly
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
```

# Data cleaning and setup

### Initial steps

- Load the required packages

```{r}
library(Hmisc)
library(splines)
library(here)
```

- Download the data

The example dataset is Byar & Greene prostate cancer data, downloaded from the following [website](https://hbiostat.org/data/). The data dictionary available [here](https://hbiostat.org/data/repo/Cprostate.html).
**Note**: Please note that there are many slightly different versions of this dataset, and the one in this website is not identical to the one used in Young et al. and Stensrud et al. For this workshop, we recommend using the version of this data that is located in this repository. [Link](https://github.com/palolili23/2022_ser_competing_events/blob/main/R/prostate.csv)

```{r}
prostate <- read.csv(here::here("R", "prostate.csv"), sep = ';')
```

- Load utility functions, these are located in the github repository. [Link](https://github.com/palolili23/2022_ser_competing_events/blob/main/R/utility_functions.R)

```{r}
source(here::here("R", "utility_functions.R"))
```

### Data cleaning

- Create a binary variable to indicate all-cause death

```{r}
prostate$allCause <- prostate$status != "alive"
```

- Create a variable with 3 levels indicating the cause of death 

```{r}
prostate$eventType <- as.factor(prostate$status)

levels(prostate$eventType) <-
  list(alive = "alive",
       pdeath = "dead - prostatic ca",
       odeath = c(levels(prostate$eventType)[c(2:5, 7:10)]))
```

- Filter data to only include high dose DES (A=1) and placebo (A=0)

```{r}
prostate$rx <- as.factor(prostate$rx)
prostRed <- prostate[prostate$rx %in% levels(prostate$rx)[3:4], ]
prostRed$temprx = as.integer(prostRed$rx) - 3
prostRed$rx = abs(1 - prostRed$temprx) # DES is A=1 and placebo A=0
prostRed$eventType = as.integer(prostRed$eventType) - 1 #0 is censoring, 1 is pdeath, 2 is odeath
prostRed$hgBinary <- prostRed$hg < 12
prostRed$ageCat <- cut2(prostRed$age, c(0, 60, 70, 80, 100))
prostRed$normalAct <- prostRed$pf == "normal activity"
prostRed$eventCens <- prostRed$eventType == 0
prostRed$eventProst <- prostRed$eventType == 1
prostRed$Tstart = -0.01 #Needed for the long format

```

- Descriptive information

```{r}
table(prostRed$eventType, prostRed$rx)
```

### Convert data to long format

```{r}
cutTimes <- c(0:59)

longProstRed <-
  survSplit(
    data = prostRed,
    cut = cutTimes,
    start = "Tstart",
    end = "dtime",
    event = "allCause")

longProstRedCens <-
  survSplit(
    data = prostRed,
    cut = cutTimes,
    start = "Tstart",
    end = "dtime",
    event = "eventCens")

longProstRed$eventCens <- longProstRedCens$eventCens

# Make column for prostate cancer mortality
longProstRed$prostateDeath <-
  longProstRed$allCause == 1 &  longProstRed$eventType == 1

longProstRed$otherDeath <-
  longProstRed$allCause == 1 & longProstRed$eventType == 2

```

To be sure that right risk sets are used in models for this data structure without explicit conditioning, set "future values" of D and Y to missing on a given line if C=1 on that line and set future values of Y to missing on a line if D=1 on that line (respects "order" C,D,Y in each interval) -- nonissue when there are no "ties" but with month long intervals there might be.

```{r}
longProstRed$prostateDeath[longProstRed$eventCens == 1] <- NA

longProstRed$otherDeath[longProstRed$eventCens == 1] <- NA

longProstRed$prostateDeath[longProstRed$otherDeath == 1] <- NA
```

Restrict input data set to records with dtime < K + 1 for fitting pooled over time models

```{r}
longProstRed <- longProstRed[longProstRed$dtime < length(cutTimes), ]
```

Create 'baseline' - data collected at visit 0

```{r}
baseline <- longProstRed[longProstRed$dtime == 0, ]
```

Save number of subjects

```{r}
n <- length(unique(longProstRed$patno))
```


# Direct, total and separable effects, using IPW

[Click here](https://palolili23.github.io/2022_ser_competing_events/R/ipw.html)

# Direct, total and separable effects, using G-formula

[Click here](https://palolili23.github.io/2022_ser_competing_events/R/gform.html)

# References

- Young JG, Stensrud MJ, Tchetgen Tchetgen EJ, Hernán MA. A causal framework for classical statistical estimands in failure time settings with competing events. Statistics in Medicine 2020. [Paper link](https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.8471) [Code](https://github.com/CausalInference/CompetingEvents_Young_SIM_2020)

- Stensrud MJ, Young JG, Didelez V, Robins JM, Hernán MA. Separable Effects for Causal Inference in the Presence of Competing Events. Journal of the American Statistical Association 2022. [Paper link](https://www.tandfonline.com/doi/full/10.1080/01621459.2020.1765783)



